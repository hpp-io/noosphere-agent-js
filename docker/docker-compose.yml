# =============================================================================
# Noosphere Agent - Docker Compose (Docker-in-Docker)
# =============================================================================
#
# SECURITY: All sensitive data is passed at runtime, NOT baked into image
#   - KEYSTORE_PASSWORD: via environment variable
#   - config.json: mounted as volume
#   - keystore.json: mounted as volume
#
# Usage (from project root):
#   # Option 1: Using local Verdaccio registry (for development with local SDK)
#   #   First, start Verdaccio from noosphere-sdk:
#   #   cd ../noosphere-sdk && docker compose -f docker/docker-compose.yml up -d
#   #   ./scripts/publish-local.sh
#   #   Then build agent:
#   docker compose -f docker/docker-compose.yml build --build-arg NPM_REGISTRY=http://host.docker.internal:4873
#   docker compose -f docker/docker-compose.yml up -d
#
#   # Option 2: Using public npm registry (production)
#   docker compose -f docker/docker-compose.yml build --build-arg NPM_REGISTRY=https://registry.npmjs.org
#   docker compose -f docker/docker-compose.yml up -d
#
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Noosphere Agent
  # ---------------------------------------------------------------------------
  agent:
    build:
      context: ..
      dockerfile: docker/Dockerfile
      args:
        # Default: use public npm registry
        # For local SDK testing: --build-arg NPM_REGISTRY=http://host.docker.internal:4873
        NPM_REGISTRY: https://registry.npmjs.org
    image: noosphere-agent:latest
    container_name: noosphere-agent
    restart: unless-stopped
    stop_grace_period: 30s  # Allow more time for graceful shutdown (DB checkpoint)

    # Environment variables from .env file
    # Required: KEYSTORE_PASSWORD
    # Optional: PAYMENT_ADDRESS, LLMROUTER_API_KEY, GEMINI_API_KEY, PROOF_SERVICE_PRIVATE_KEY, etc.
    env_file:
      - ../.env

    environment:
      - NODE_ENV=production
      - NOOSPHERE_DATA_DIR=/app/.noosphere
      - DASHBOARD_ENABLED=true
      # Pass the docker-compose network name for DinD container communication
      - DOCKER_NETWORK=noosphere_network
      # File-based logging (daily rotation with 7-day retention)
      - LOG_DIR=/app/logs
      - LOG_LEVEL=info
      - LOG_MAX_SIZE=52428800
      - LOG_RETENTION_DAYS=7

    extra_hosts:
      - "host.docker.internal:host-gateway"

    ports:
      - "3000:3000"  # Next.js Dashboard
      - "4000:4000"  # Express API

    volumes:
      # Docker socket - for container management
      - /var/run/docker.sock:/var/run/docker.sock

      # Configuration file (mounted at runtime, NOT in image)
      # Use config.docker.anvil.json for Anvil testing, config.docker.json for Sepolia
      - ./config.docker.anvil.json:/app/config.json:ro

      # Persistent data directory (includes agent.db, agent.db-wal, agent.db-shm, registry.json)
      # Mounting entire directory ensures SQLite WAL files are persisted
      - ../.noosphere:/app/.noosphere

      # Log files directory
      - ../logs:/app/logs

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

    networks:
      - noosphere

  # SQLite Web UI for database management
  # Access: http://localhost:18080
  sqlite-web:
    image: coleifer/sqlite-web
    container_name: noosphere-sqlite-web
    restart: unless-stopped
    ports:
      - "18080:8080"
    volumes:
      - ../.noosphere:/data
    command: sqlite_web -H 0.0.0.0 -x /data/agent.db
    networks:
      - noosphere

networks:
  noosphere:
    name: noosphere_network
    driver: bridge
